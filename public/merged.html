<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Tree - Merged Interface</title>
    <style>
        body { 
            margin: 0; 
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: #1a1a1a;
            color: #ffffff;
        }
        canvas { 
            position: fixed;
            top: 0;
            left: 0;
            outline: none;
        }

        /* Window styling */
        .window {
            background: rgba(26, 27, 38, 0.95);
            border: 1px solid #444;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: absolute;
            min-width: 300px;
            z-index: 1000;
        }

        .title-bar {
            background: #24283b;
            color: #7aa2f7;
            padding: 8px 12px;
            font-weight: 500;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .minimize-btn {
            cursor: pointer;
            padding: 0 4px;
            color: #a9b1d6;
        }

        .minimize-btn:hover {
            color: #7aa2f7;
        }

        /* Controls styling */
        #controls-window {
            top: 10px;
            left: 10px;
            width: 300px;
        }

        .control-group {
            padding: 12px;
            border-bottom: 1px solid #444;
        }

        .control-group:last-child {
            border-bottom: none;
        }

        .control-label {
            display: block;
            color: #7aa2f7;
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .control-button {
            width: 100%;
            padding: 8px;
            margin: 4px 0;
            background: #24283b;
            border: 1px solid #444;
            color: #a9b1d6;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-button:hover {
            background: #2f354d;
            border-color: #7aa2f7;
        }

        .control-slider {
            width: 100%;
            margin: 8px 0;
        }

        .color-picker {
            width: 100%;
            padding: 4px;
            background: #24283b;
            border: 1px solid #444;
            margin: 4px 0;
        }

        /* Window positioning */
        #stats-window {
            top: 10px;
            right: 10px;
            width: 350px;
        }

        #users-window {
            top: 250px;
            right: 10px;
            width: 350px;
        }

        #log-window {
            bottom: 10px;
            right: 10px;
            width: 350px;
            max-height: 300px;
        }

        /* Table styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        .data-table th,
        .data-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        .data-table th {
            background: #24283b;
            color: #7aa2f7;
            font-weight: 500;
        }

        .data-table tr:hover {
            background: rgba(36, 40, 59, 0.5);
        }

        /* Grid and light controls */
        .grid-controls {
            padding: 12px;
        }

        .grid-controls input[type="range"] {
            width: 100%;
            margin: 8px 0;
        }

        .grid-controls input[type="color"] {
            width: 100%;
            height: 30px;
            padding: 2px;
            background: #24283b;
            border: 1px solid #444;
            margin: 4px 0;
        }

        /* Status Indicators */
        .status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-online {
            background: #28a745;
        }

        .status-afk {
            background: #ffc107;
        }

        /* Log Entries */
        .log-entry {
            padding: 4px 8px;
            border-bottom: 1px solid #333;
            font-family: monospace;
        }

        .log-entry .timestamp {
            color: #007bff;
            margin-right: 8px;
        }

        /* Minimize/Maximize */
        .window.minimized {
            height: 40px;
            overflow: hidden;
        }

        /* Badges */
        .badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-right: 4px;
        }

        .badge.user { background: #007bff; }
        .badge.viewer { background: #28a745; }
        .badge.mobile { background: #dc3545; }
        .badge.desktop { background: #6c757d; }

        /* Navigation Menu */
        #nav-menu {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.95);
            padding: 10px;
            border-radius: 0 0 8px 8px;
            z-index: 2000;
            display: flex;
            gap: 10px;
        }

        #nav-menu a {
            color: white;
            text-decoration: none;
            padding: 5px 15px;
            border-radius: 4px;
            background: #333;
            transition: background 0.3s;
        }

        #nav-menu a:hover {
            background: #444;
        }

        #nav-menu a.active {
            background: #007bff;
        }

        /* Add dashboard-style classes */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-dot.online { background: #28a745; }
        .status-dot.offline { background: #dc3545; }
        .status-dot.connecting { background: #ffc107; }

        .status-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .server-info {
            margin: 10px 0;
            padding: 5px 0;
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .info-label {
            color: #7aa2f7;
        }

        .users-table-container {
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .data-table th {
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1;
        }

        .badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-right: 4px;
        }

        .badge.user { background: #007bff; }
        .badge.viewer { background: #28a745; }
        .badge.mobile { background: #dc3545; }
        .badge.desktop { background: #6c757d; }

        .status-cell {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <canvas id="three-canvas"></canvas>

    <!-- Navigation Menu -->
    <div id="nav-menu">
        <a href="/index.html">Original</a>
        <a href="/" class="active">Merged</a>
        <a href="/dashboard.html">Dashboard</a>
    </div>

    <!-- Controls Window -->
    <div id="controls-window" class="window">
        <div class="title-bar">
            Controls
            <span class="minimize-btn">−</span>
        </div>
        <div class="control-group">
            <button class="control-button" onclick="toggleOrbitCamera()">Toggle Orbit Camera</button>
            <button class="control-button" onclick="centerCamera()">Center Camera</button>
            <button class="control-button" onclick="toggleGrid()">Toggle Grid</button>
        </div>
        <div class="control-group">
            <label class="control-label">Light Color</label>
            <input type="color" class="color-picker" id="light-color" value="#ff0000">
            
            <label class="control-label">Light Intensity</label>
            <input type="range" class="control-slider" id="light-intensity" min="0" max="2" step="0.1" value="0.5">
            
            <label class="control-label">Grid Color</label>
            <input type="color" class="color-picker" id="grid-color" value="#ff0000">
        </div>
    </div>

    <!-- Users Window -->
    <div id="users-window" class="window">
        <div class="title-bar">
            Connected Users
            <span class="minimize-btn">−</span>
        </div>
        <div class="users-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Position</th>
                        <th>Info</th>
                    </tr>
                </thead>
                <tbody id="users-table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Stats Window -->
    <div id="stats-window" class="window">
        <div class="title-bar">
            Server Statistics
            <span class="minimize-btn">−</span>
        </div>
        <div class="status-container">
            <div class="status-dot online" id="connection-dot"></div>
            <span id="connection-status">Connecting...</span>
        </div>
        <div class="server-info">
            <div class="info-row">
                <span class="info-label">Server:</span>
                <span>ws://localhost:3001</span>
            </div>
            <div class="info-row">
                <span class="info-label">Client ID:</span>
                <span id="client-uuid">Connecting...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Connected Users:</span>
                <span id="user-count">0</span>
            </div>
            <div class="info-row">
                <span class="info-label">Dashboard Viewers:</span>
                <span id="viewer-count">0</span>
            </div>
            <div class="info-row">
                <span class="info-label">Last Save:</span>
                <span id="last-save">Never</span>
            </div>
            <div class="info-row">
                <span class="info-label">Ping:</span>
                <span id="ping-status">--</span>
            </div>
        </div>
    </div>

    <!-- Log Window -->
    <div id="log-window" class="window">
        <div class="title-bar">
            Event Log
            <span class="minimize-btn">−</span>
        </div>
        <div id="log-container"></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        // Scene setup and global variables
        let scene, camera, renderer, controls, labelRenderer;
        let grid;
        const userSpheres = new Map();
        const userLabels = new Map();
        let ws;
        let userId;
        let userSecret;
        let lastSaveTime = null;
        let activeUsers = new Map();
        let dashboardViewers = new Map();
        let useOrbitCamera = true;

        // Initialize Three.js scene
        function initScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('three-canvas'),
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 1);
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.toneMapping = THREE.NoToneMapping;

            // Label renderer for user names
            labelRenderer = new CSS2DRenderer();
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.domElement.style.position = 'absolute';
            labelRenderer.domElement.style.top = '0';
            labelRenderer.domElement.style.pointerEvents = 'none';
            document.body.appendChild(labelRenderer.domElement);

            // Orbit controls with auto-rotation
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.minDistance = 1;
            controls.maxDistance = 50;
            controls.maxPolarAngle = Math.PI;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.5;

            // Auto-rotation handling
            let isUserInteracting = false;
            controls.addEventListener('start', () => {
                isUserInteracting = true;
            });
            controls.addEventListener('end', () => {
                isUserInteracting = false;
            });

            // Add a cube
            const geometry = new THREE.BoxGeometry();
            const material = new THREE.MeshPhongMaterial({ color: 0x808080, shininess: 100 });
            const cube = new THREE.Mesh(geometry, material);
            scene.add(cube);

            // Store cube's original color
            cube.userData.originalColor = new THREE.Color(0x808080);
            window.cube = cube;

            // Add light
            const ambientLight = new THREE.AmbientLight(0xff0000, 0.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xff0000, 4);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            // Create a parent object for sphere
            const parent = new THREE.Object3D();
            scene.add(parent);

            // Add a sphere
            const sphereGeometry = new THREE.SphereGeometry(0.25, 32, 32);
            const sphereMaterial = new THREE.MeshPhongMaterial({ color: 0x808080, shininess: 100 });
            const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
            sphere.position.x = 2;
            parent.add(sphere);

            // Add an arc
            const arcGeometry = new THREE.RingGeometry(1, 1.01, 32);
            const arcMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide });
            const arc = new THREE.Mesh(arcGeometry, arcMaterial);
            arc.rotation.x = Math.PI / 2;
            arc.scale.set(2, 2, 2);
            scene.add(arc);

            // Add stationary camera
            const stationaryCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            stationaryCamera.position.set(0, 0, 10);
            const cameraPivot = new THREE.Object3D();
            cameraPivot.rotation.x = 45;
            cameraPivot.add(stationaryCamera);
            scene.add(cameraPivot);

            // Create labels
            function createLabel(name) {
                const div = document.createElement('div');
                div.className = 'label';
                div.textContent = name;
                div.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
                div.style.color = 'white';
                div.style.padding = '2px 5px';
                div.style.borderRadius = '3px';
                div.style.fontSize = '12px';
                return new CSS2DObject(div);
            }

            // Add labels to objects
            const cubeLabel = createLabel('Cube');
            cube.add(cubeLabel);
            cubeLabel.position.set(0, 1.2, 0);

            const sphereLabel = createLabel('Sphere');
            sphere.add(sphereLabel);
            sphereLabel.position.set(0, 0.6, 0);

            const arcLabel = createLabel('Ring');
            arc.add(arcLabel);
            arcLabel.position.set(0, 0.2, 0);

            // Create large grid
            const gridGeometry = new THREE.PlaneGeometry(500, 500, 100, 100);
            const gridMaterial = new THREE.MeshBasicMaterial({
                color: 0xff0000,
                wireframe: true,
                transparent: true,
                opacity: 0.1
            });
            grid = new THREE.Mesh(gridGeometry, gridMaterial);
            grid.rotation.x = -Math.PI / 2;
            grid.visible = true;
            scene.add(grid);

            const gridLabel = createLabel('Grid');
            grid.add(gridLabel);
            gridLabel.position.set(0, 0.5, 0);

            camera.position.set(5, 3, 5);
            camera.lookAt(0, 0, 0);

            // Store references for animation
            window.cube = cube;
            window.parent = parent;
            window.stationaryCamera = stationaryCamera;

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (window.cube) {
                window.cube.rotation.x += 0.01;
                window.cube.rotation.y += 0.01;
            }
            if (window.parent) {
                window.parent.rotation.y += 0.005;
            }
            controls.update();
            renderer.render(scene, useOrbitCamera ? camera : window.stationaryCamera);
            labelRenderer.render(scene, useOrbitCamera ? camera : window.stationaryCamera);
        }

        // Window resize handler
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
        }

        // User visualization
        function createUserSphere(color = 0x7aa2f7) {
            const geometry = new THREE.SphereGeometry(0.2, 32, 32);
            const material = new THREE.MeshPhongMaterial({ color });
            return new THREE.Mesh(geometry, material);
        }

        function createUserLabel(text) {
            const div = document.createElement('div');
            div.className = 'label';
            div.textContent = text;
            div.style.color = 'white';
            div.style.fontSize = '12px';
            return new CSS2DObject(div);
        }

        function updateUserPosition(userId, coordinates, username) {
            let userSphere = userSpheres.get(userId);
            let userLabel = userLabels.get(userId);

            if (!userSphere) {
                userSphere = createUserSphere();
                scene.add(userSphere);
                userSpheres.set(userId, userSphere);

                userLabel = createUserLabel(username || `User_${userId.slice(0, 5)}`);
                userSphere.add(userLabel);
                userLabel.position.set(0, 0.3, 0);
                userLabels.set(userId, userLabel);
            }

            // Update position with smooth transition
            const targetPosition = new THREE.Vector3(coordinates.tx, coordinates.ty, coordinates.tz);
            const currentPosition = userSphere.position;
            
            // Smoothly interpolate to new position
            currentPosition.lerp(targetPosition, 0.1);

            // Update position in users table
            updateUserPositionInTable(userId, coordinates);
        }

        // WebSocket connection
        function initWebSocket() {
            ws = new WebSocket('ws://localhost:3001');
            document.getElementById('connection-dot').className = 'status-dot connecting';
            document.getElementById('connection-status').textContent = 'Connecting...';

            ws.onopen = () => {
                addLogEntry('Connected to server', 'success');
                document.getElementById('connection-dot').className = 'status-dot online';
                document.getElementById('connection-status').textContent = 'Connected';
                document.getElementById('connection-status').style.color = '#28a745';

                // Send reconnect message
                ws.send(JSON.stringify({
                    type: 'reconnect',
                    secret: localStorage.getItem('userSecret'),
                    username: 'Merged Interface User'
                }));
            };

            ws.onclose = () => {
                addLogEntry('Disconnected from server', 'error');
                document.getElementById('connection-dot').className = 'status-dot offline';
                document.getElementById('connection-status').textContent = 'Disconnected';
                document.getElementById('connection-status').style.color = '#dc3545';
                setTimeout(initWebSocket, 5000);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'welcome':
                    userId = data.id;
                    userSecret = data.secret;
                    localStorage.setItem('userSecret', userSecret);
                    document.getElementById('client-uuid').textContent = userId;
                    addLogEntry(`Initialized with ID: ${userId}`, 'info');
                    break;
                    
                case 'userupdate':
                    updateUserList(data.users);
                    document.getElementById('user-count').textContent = 
                        data.users.filter(u => !u.description.includes('Viewer')).length;
                    document.getElementById('viewer-count').textContent = 
                        data.users.filter(u => u.description.includes('Viewer')).length;
                    break;

                case 'position':
                    updateUserPosition(data.userId, data.coordinates, data.username);
                    break;

                case 'ping':
                    handlePing(data);
                    break;

                case 'save':
                    updateLastSave(data.timestamp);
                    break;

                default:
                    addLogEntry(`Received: ${JSON.stringify(data)}`, 'info');
            }
        }

        function updateUserList(users) {
            const userTableBody = document.getElementById('users-table-body');
            userTableBody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                const displayName = user.username || `User_${user.id.slice(0, 5)}`;
                const position = `(${user.tx.toFixed(2)}, ${user.ty.toFixed(2)}, ${user.tz.toFixed(2)})`;
                
                row.innerHTML = `
                    <td>${displayName}</td>
                    <td>
                        ${user.description === 'Dashboard Viewer' 
                            ? '<span class="badge viewer">Viewer</span>' 
                            : '<span class="badge user">User</span>'}
                    </td>
                    <td class="status-cell">
                        <div class="status-dot ${user.afk ? 'connecting' : 'online'}"></div>
                        ${user.afk ? 'AFK' : 'Online'}
                    </td>
                    <td>${position}</td>
                    <td>${user.description || ''}</td>
                `;
                
                userTableBody.appendChild(row);
            });
        }

        function updateUserPositionInTable(userId, coordinates) {
            const userTableBody = document.getElementById('users-table-body');
            if (!userTableBody) return;

            const rows = userTableBody.getElementsByTagName('tr');
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                if (cells[0].textContent.includes(userId)) {
                    cells[3].textContent = `(${coordinates.tx.toFixed(2)}, ${coordinates.ty.toFixed(2)}, ${coordinates.tz.toFixed(2)})`;
                    cells[3].style.transition = 'color 0.3s ease';
                    cells[3].style.color = '#ffc107';
                    setTimeout(() => {
                        cells[3].style.color = '#ffffff';
                    }, 300);
                    break;
                }
            }
        }

        // UI Updates
        function addLogEntry(message, type = 'info') {
            const log = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry type-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;

            // Keep only last 1000 entries
            while (log.children.length > 1000) {
                log.removeChild(log.firstChild);
            }
        }

        // Make windows draggable
        function makeWindowsDraggable() {
            document.querySelectorAll('.window').forEach(window => {
                const titleBar = window.querySelector('.title-bar');
                let isDragging = false;
                let currentX;
                let currentY;
                let initialX;
                let initialY;

                titleBar.addEventListener('mousedown', e => {
                    isDragging = true;
                    initialX = e.clientX - window.offsetLeft;
                    initialY = e.clientY - window.offsetTop;
                });

                document.addEventListener('mousemove', e => {
                    if (isDragging) {
                        e.preventDefault();
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                        
                        window.style.left = `${currentX}px`;
                        window.style.top = `${currentY}px`;
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            });
        }

        // Window minimize/maximize
        function initializeMinimizeButtons() {
            document.querySelectorAll('.minimize-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const window = btn.closest('.window');
                    window.classList.toggle('minimized');
                    btn.textContent = window.classList.contains('minimized') ? '+' : '−';
                });
            });
        }

        // Initialize everything when the page loads
        window.addEventListener('load', () => {
            initScene();
            initWebSocket();
            makeWindowsDraggable();
            initializeMinimizeButtons();

            // Event listeners
            window.addEventListener('resize', onWindowResize);
            
            document.getElementById('toggle-orbit').addEventListener('click', () => {
                useOrbitCamera = !useOrbitCamera;
                controls.enabled = useOrbitCamera;
                addLogEntry(`Switched to ${useOrbitCamera ? 'orbit' : 'stationary'} camera`, 'info');
            });

            document.getElementById('center-camera').addEventListener('click', () => {
                camera.position.set(5, 3, 5);
                camera.lookAt(0, 0, 0);
                addLogEntry('Camera centered', 'info');
            });

            document.getElementById('toggle-grid').addEventListener('click', () => {
                grid.visible = !grid.visible;
                addLogEntry(`Grid ${grid.visible ? 'shown' : 'hidden'}`, 'info');
            });

            document.getElementById('light-color').addEventListener('input', (e) => {
                scene.children.forEach(child => {
                    if (child instanceof THREE.DirectionalLight) {
                        child.color.set(e.target.value);
                    }
                });
                addLogEntry(`Light color changed to ${e.target.value}`, 'info');
            });

            document.getElementById('light-intensity').addEventListener('input', (e) => {
                scene.children.forEach(child => {
                    if (child instanceof THREE.DirectionalLight) {
                        child.intensity = parseFloat(e.target.value);
                    }
                });
                addLogEntry(`Light intensity changed to ${e.target.value}`, 'info');
            });

            document.getElementById('grid-color').addEventListener('input', (e) => {
                grid.material.color.set(e.target.value);
                addLogEntry(`Grid color changed to ${e.target.value}`, 'info');
            });
        });
    </script>
</body>
</html>
