<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KeyForge Hybrid</title>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            overflow: hidden;
            font-family: system-ui, -apple-system, sans-serif;
            color: #fff;
            touch-action: none;
        }

        #interaction-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        .draggable {
            position: absolute;
            width: 120px;
            height: 120px;
            transform: translate(-50%, -50%);
            cursor: move;
            z-index: 10;
            transition: transform 0.2s ease;
            touch-action: none;
        }

        .draggable.being-dragged {
            transform: translate(-50%, -50%) scale(1.2);
            z-index: 100;
        }

        .draggable.active {
            animation: none;
        }

        .draggable.active.circle-pulse {
            animation: circle-pulse var(--pulse-rate) infinite;
        }

        .draggable.active.square-pulse {
            animation: square-pulse var(--pulse-rate) infinite;
        }

        @keyframes circle-pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        @keyframes square-pulse {
            0% { 
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4);
                border-radius: 0;
            }
            70% { 
                box-shadow: 0 0 0 20px rgba(255, 0, 0, 0);
                border-radius: 0;
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
                border-radius: 0;
            }
        }

        .draggable.active.circle-pulse::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,0,0,0.2) 0%, rgba(255,0,0,0) 70%);
        }

        .draggable.active.square-pulse::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 0;
            background: radial-gradient(circle, rgba(255,0,0,0.2) 0%, rgba(255,0,0,0) 70%);
        }

        .interaction-point {
            border: 4px solid rgba(0, 255, 0, 0.8);
            border-radius: 50%;
            mix-blend-mode: plus-lighter;
            pointer-events: none;
            touch-action: none;
        }

        .interaction-point::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: rgba(0, 255, 0, 0.8);
            border-radius: 50%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .hold-indicator {
            position: absolute;
            border: 4px solid rgba(255, 0, 0, 0.8);
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: pulse 1s infinite;
            mix-blend-mode: plus-lighter;
            pointer-events: none;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        #debug-console {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 400px;
            max-height: calc(100vh - 40px);
            background: rgba(45, 45, 45, 0.4);
            border-radius: 8px;
            overflow-y: auto;
            font-family: monospace;
            padding: 10px;
            pointer-events: none;
            mix-blend-mode: plus-lighter;
            font-size: 14px;
            z-index: 1000;
        }

        .debug-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid rgba(102, 102, 102, 0.8);
            color: rgba(255, 255, 255, 0.9);
        }

        .debug-entry.interaction-start { border-left-color: rgba(76, 175, 80, 0.8); }
        .debug-entry.interaction-move { border-left-color: rgba(33, 150, 243, 0.8); }
        .debug-entry.interaction-end { border-left-color: rgba(244, 67, 54, 0.8); }
        .debug-entry.hold { border-left-color: rgba(255, 152, 0, 0.8); }
        .debug-entry.state-change { border-left-color: rgba(255, 0, 0, 0.8); }
        .debug-entry.pulse-rate-change { border-left-color: rgba(0, 255, 0, 0.8); }
        .debug-entry.shape-change { border-left-color: rgba(0, 0, 255, 0.8); }

        .create-menu {
            position: fixed;
            width: 200px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px;
            z-index: 1000;
            display: none;
            transform-origin: center;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .create-menu.active {
            transform: scale(1);
            opacity: 1;
        }

        .create-option {
            display: inline-block;
            width: 50px;
            height: 50px;
            margin: 4px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .create-option:hover,
        .create-option.selected {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .context-menu {
            position: absolute;
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            font-family: 'Segoe UI', sans-serif;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            color: #fff;
            transition: all 0.2s ease;
            user-select: none;
        }

        .context-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .context-menu-item.active {
            background: rgba(255, 255, 255, 0.15);
        }

        .context-menu-item .icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .context-menu-item .label {
            flex-grow: 1;
        }

        .context-menu-item .status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            background: rgba(255, 255, 255, 0.2);
        }

        .context-menu-item .status.active {
            background: #00ff00;
        }

        .context-menu-separator {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 4px 0;
        }

        @keyframes pulse-circle {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        @keyframes pulse-square {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            100% { transform: scale(1.5) rotate(45deg); opacity: 0; }
        }

        @keyframes pulse-triangle {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            100% { transform: scale(1.5) rotate(120deg); opacity: 0; }
        }

        @keyframes pulse-star {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            100% { transform: scale(1.5) rotate(180deg); opacity: 0; }
        }

        @keyframes pulse-ripple {
            0% { transform: scale(0.8); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.5; }
            100% { transform: scale(0.8); opacity: 1; }
        }

        .pulse-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation-iteration-count: infinite;
            animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pulse-primary {
            border: 2px solid rgba(0, 255, 255, 0.5);
        }

        .pulse-secondary {
            border: 2px solid rgba(255, 0, 255, 0.5);
        }

        .shape-circle .pulse {
            border-radius: 50%;
            animation-name: pulse-circle;
        }

        .shape-square .pulse {
            border-radius: 0;
            animation-name: pulse-square;
        }

        .shape-triangle .pulse {
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            animation-name: pulse-triangle;
        }

        .shape-star .pulse {
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation-name: pulse-star;
        }

        .shape-ripple .pulse {
            animation-name: pulse-ripple;
        }

        .metadata {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            white-space: pre;
            z-index: 1000;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
        }

        @media (hover: hover) {
            .draggable:hover .metadata {
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            #debug-console {
                width: calc(100vw - 40px);
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="interaction-area"></div>
    <div id="debug-console"></div>

    <script>
        const interactionArea = document.getElementById('interaction-area');
        const debugConsole = document.getElementById('debug-console');
        const activePoints = new Map();
        const holdTimers = new Map();
        const HOLD_THRESHOLD = 500; // ms
        let activeDraggable = null;
        let dragStartTime = 0;
        const DRAG_THRESHOLD = 150; // ms
        let objectCounter = 0;
        let createMenuActive = false;
        let createStartPosition = null;
        let selectedOption = null;
        let isTouchDevice = false;
        let holdStartPosition = null;
        let lastTapTime = 0;
        let isHolding = false;
        const DOUBLE_TAP_THRESHOLD = 300; // ms

        // Detect touch capability
        window.addEventListener('touchstart', function onFirstTouch() {
            isTouchDevice = true;
            window.removeEventListener('touchstart', onFirstTouch);
        });

        function addDebugEntry(type, data) {
            const entry = document.createElement('div');
            entry.className = `debug-entry ${type}`;
            entry.textContent = `${type}: ${JSON.stringify(data)}`;
            debugConsole.appendChild(entry);
            debugConsole.scrollTop = debugConsole.scrollHeight;
            
            if (debugConsole.childNodes.length > 50) {
                debugConsole.removeChild(debugConsole.firstChild);
            }
        }

        function createObject(emoji) {
            const obj = document.createElement('div');
            obj.className = 'draggable';
            obj.dataset.type = 'object';
            obj.dataset.id = `obj-${++objectCounter}`;
            obj.dataset.state = 'inactive';
            obj.dataset.pulseRate = '1s';
            obj.dataset.pulseShape = Math.random() < 0.5 ? 'circle' : 'square';
            obj.dataset.primaryPulse = 'inactive';
            obj.dataset.secondaryPulse = 'inactive';
            obj.style.setProperty('--pulse-rate', obj.dataset.pulseRate);
            obj.style.left = `${window.innerWidth / 2}px`;
            obj.style.top = `${window.innerHeight / 2}px`;
            obj.innerHTML = `
                <div style="font-size: 48px; text-align: center; line-height: 120px;">${emoji}</div>
                <div class="metadata">ID: ${obj.dataset.id}
Type: ${emoji}
Primary Pulse: ${obj.dataset.primaryPulse}
Secondary Pulse: ${obj.dataset.secondaryPulse}
Shape: ${obj.dataset.pulseShape}
Rate: ${obj.dataset.pulseRate}</div>
            `;
            interactionArea.appendChild(obj);
            return obj;
        }

        function createContextMenu(target, x, y) {
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            
            const shapes = [
                { id: 'circle', icon: '⭕', label: 'Circle' },
                { id: 'square', icon: '⬛', label: 'Square' },
                { id: 'triangle', icon: '△', label: 'Triangle' },
                { id: 'star', icon: '⭐', label: 'Star' },
                { id: 'ripple', icon: '◎', label: 'Ripple' }
            ];

            const pulseTypes = [
                { id: 'primary', icon: '🔵', label: 'Primary Pulse' },
                { id: 'secondary', icon: '🔴', label: 'Secondary Pulse' }
            ];

            menu.innerHTML = `
                <div class="context-menu-item" data-action="toggle-info">
                    <div class="icon">ℹ️</div>
                    <div class="label">Toggle Information</div>
                </div>
                <div class="context-menu-separator"></div>
                ${pulseTypes.map(pulse => `
                    <div class="context-menu-item" data-action="toggle-pulse" data-pulse="${pulse.id}">
                        <div class="icon">${pulse.icon}</div>
                        <div class="label">${pulse.label}</div>
                        <div class="status ${target.dataset[pulse.id + 'Pulse'] === 'active' ? 'active' : ''}"></div>
                    </div>
                `).join('')}
                <div class="context-menu-separator"></div>
                ${shapes.map(shape => `
                    <div class="context-menu-item ${target.dataset.pulseShape === shape.id ? 'active' : ''}" 
                         data-action="set-shape" data-shape="${shape.id}">
                        <div class="icon">${shape.icon}</div>
                        <div class="label">${shape.label}</div>
                    </div>
                `).join('')}
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" data-action="set-rate">
                    <div class="icon">⚡</div>
                    <div class="label">Pulse Rate: ${target.dataset.pulseRate}</div>
                </div>
            `;

            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;

            // Ensure menu stays within viewport
            document.body.appendChild(menu);
            const menuRect = menu.getBoundingClientRect();
            if (menuRect.right > window.innerWidth) {
                menu.style.left = `${x - menuRect.width}px`;
            }
            if (menuRect.bottom > window.innerHeight) {
                menu.style.top = `${y - menuRect.height}px`;
            }

            // Add event listeners
            menu.addEventListener('click', (e) => {
                const item = e.target.closest('.context-menu-item');
                if (!item) return;

                const action = item.dataset.action;
                switch (action) {
                    case 'toggle-info':
                        toggleObjectInfo(target);
                        break;
                    case 'toggle-pulse':
                        const pulseType = item.dataset.pulse;
                        togglePulse(target, pulseType);
                        break;
                    case 'set-shape':
                        const shape = item.dataset.shape;
                        setShape(target, shape);
                        break;
                    case 'set-rate':
                        startRateAdjustment(target, x, y);
                        break;
                }
                menu.remove();
            });

            return menu;
        }

        function toggleObjectInfo(obj) {
            const metadata = obj.querySelector('.metadata');
            metadata.style.display = metadata.style.display === 'none' ? 'block' : 'none';
        }

        function togglePulse(obj, pulseType) {
            const currentState = obj.dataset[pulseType + 'Pulse'];
            const newState = currentState === 'active' ? 'inactive' : 'active';
            obj.dataset[pulseType + 'Pulse'] = newState;
            
            const pulseContainer = obj.querySelector('.pulse-container');
            if (!pulseContainer) {
                const container = document.createElement('div');
                container.className = 'pulse-container';
                obj.appendChild(container);
            }

            updatePulseAnimations(obj);
        }

        function setShape(obj, shape) {
            obj.dataset.pulseShape = shape;
            obj.className = `draggable shape-${shape}`;
            updatePulseAnimations(obj);
        }

        function updatePulseAnimations(obj) {
            const container = obj.querySelector('.pulse-container');
            if (!container) return;

            container.innerHTML = '';
            
            if (obj.dataset.primaryPulse === 'active') {
                const pulse = document.createElement('div');
                pulse.className = 'pulse pulse-primary';
                pulse.style.animationDuration = obj.dataset.pulseRate;
                container.appendChild(pulse);
            }

            if (obj.dataset.secondaryPulse === 'active') {
                const pulse = document.createElement('div');
                pulse.className = 'pulse pulse-secondary';
                pulse.style.animationDuration = obj.dataset.pulseRate;
                container.appendChild(pulse);
            }
        }

        let rateAdjustmentStart = null;

        function startRateAdjustment(obj, startX, startY) {
            rateAdjustmentStart = { 
                x: startX, 
                y: startY, 
                initialRate: parseFloat(obj.dataset.pulseRate),
                axis: null
            };
            
            function onMouseMove(e) {
                if (!rateAdjustmentStart) return;
                
                const dx = e.pageX - rateAdjustmentStart.x;
                const dy = e.pageY - rateAdjustmentStart.y;
                
                // Determine axis if not set
                if (!rateAdjustmentStart.axis) {
                    if (Math.abs(dx) > Math.abs(dy)) {
                        rateAdjustmentStart.axis = 'x';
                    } else {
                        rateAdjustmentStart.axis = 'y';
                    }
                }
                
                // Calculate rate based on axis distance
                const distance = Math.abs(rateAdjustmentStart.axis === 'x' ? dx : dy);
                const newRate = Math.max(0.1, Math.min(5, distance / 100));
                
                obj.dataset.pulseRate = `${newRate.toFixed(1)}s`;
                obj.style.setProperty('--pulse-rate', `${newRate}s`);
                updatePulseAnimations(obj);
            }

            function onMouseUp() {
                rateAdjustmentStart = null;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        function cancelHoldTimer(identifier) {
            const timer = holdTimers.get(identifier);
            if (timer) {
                clearTimeout(timer);
                holdTimers.delete(identifier);
            }
            isHolding = false;
        }

        function startHoldTimer(point, target) {
            const identifier = point.identifier ?? 'mouse';
            cancelHoldTimer(identifier);
            
            const timer = setTimeout(() => {
                isHolding = true;
                if (target.dataset.type === 'create') {
                    showCreateMenu(point.clientX, point.clientY);
                } else {
                    createContextMenu(target, point.clientX, point.clientY);
                }
            }, HOLD_THRESHOLD);
            
            holdTimers.set(identifier, timer);
        }

        // Add document click handler to close context menu
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu') && !isHolding) {
                const menu = document.querySelector('.context-menu');
                if (menu) menu.remove();
            }
        });

        function findDraggableTarget(point) {
            const elements = document.elementsFromPoint(point.clientX, point.clientY);
            return elements.find(el => el.classList.contains('draggable'));
        }

        function showCreateMenu(x, y) {
            const menu = document.createElement('div');
            menu.className = 'create-menu';
            menu.innerHTML = `
                <div class="create-option" data-emoji="🔵">🔵</div>
                <div class="create-option" data-emoji="🔴">🔴</div>
                <div class="create-option" data-emoji="🟡">🟡</div>
                <div class="create-option" data-emoji="🟢">🟢</div>
                <div class="create-option" data-emoji="⚫">⚫</div>
                <div class="create-option" data-emoji="🟣">🟣</div>
                <div class="create-option" data-emoji="⚪">⚪</div>
                <div class="create-option" data-emoji="🟤">🟤</div>
            `;

            // Position menu
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;

            // Ensure menu stays within viewport
            document.body.appendChild(menu);
            const menuRect = menu.getBoundingClientRect();
            if (menuRect.right > window.innerWidth) {
                menu.style.left = `${x - menuRect.width}px`;
            }
            if (menuRect.bottom > window.innerHeight) {
                menu.style.top = `${y - menuRect.height}px`;
            }

            // Show menu with animation
            menu.style.display = 'block';
            requestAnimationFrame(() => menu.classList.add('active'));

            // Add hover effect
            menu.addEventListener('mousemove', (e) => {
                const option = e.target.closest('.create-option');
                if (option) {
                    document.querySelectorAll('.create-option').forEach(opt => 
                        opt.classList.remove('selected'));
                    option.classList.add('selected');
                }
            });

            createMenuActive = true;
            return menu;
        }

        function hideCreateMenu() {
            const menu = document.querySelector('.create-menu');
            if (menu) {
                menu.classList.remove('active');
                setTimeout(() => menu.remove(), 200);
            }
            createMenuActive = false;
        }

        function createObjectAtPosition(emoji, x, y) {
            const obj = document.createElement('div');
            obj.className = 'draggable';
            obj.dataset.type = 'object';
            obj.dataset.id = `obj-${++objectCounter}`;
            obj.dataset.state = 'inactive';
            obj.dataset.pulseRate = '1s';
            obj.dataset.pulseShape = Math.random() < 0.5 ? 'circle' : 'square';
            obj.dataset.primaryPulse = 'inactive';
            obj.dataset.secondaryPulse = 'inactive';
            obj.style.setProperty('--pulse-rate', obj.dataset.pulseRate);
            obj.style.left = `${x}px`;
            obj.style.top = `${y}px`;
            obj.innerHTML = `
                <div style="font-size: 48px; text-align: center; line-height: 120px;">${emoji}</div>
                <div class="metadata">ID: ${obj.dataset.id}
Type: ${emoji}
Primary Pulse: ${obj.dataset.primaryPulse}
Secondary Pulse: ${obj.dataset.secondaryPulse}
Shape: ${obj.dataset.pulseShape}
Rate: ${obj.dataset.pulseRate}</div>
            `;
            interactionArea.appendChild(obj);
            return obj;
        }

        // Prevent default context menu
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });

        // Mouse event handlers
        document.addEventListener('mousedown', (e) => {
            if (isTouchDevice) return;

            // Right click for context menu
            if (e.button === 2) {
                const target = findDraggableTarget(e);
                if (target) {
                    createContextMenu(target, e.clientX, e.clientY);
                } else {
                    showCreateMenu(e.clientX, e.clientY);
                }
                return;
            }

            // Left click for dragging
            if (e.button === 0 && !activeDraggable) {
                const target = findDraggableTarget(e);
                if (target) {
                    activeDraggable = target;
                    menuInteractionId = 'mouse';
                    dragStartTime = Date.now();
                    target.classList.add('being-dragged');
                    holdStartPosition = { x: e.pageX, y: e.pageY };
                }
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isTouchDevice) return;

            if (activeDraggable) {
                activeDraggable.style.left = `${e.pageX}px`;
                activeDraggable.style.top = `${e.pageY}px`;
            }
        });

        document.addEventListener('mouseup', (e) => {
            if (isTouchDevice) return;

            // Handle create menu selection
            if (createMenuActive && e.button === 2) {
                const option = e.target.closest('.create-option');
                if (option) {
                    const emoji = option.dataset.emoji;
                    createObjectAtPosition(emoji, e.pageX, e.pageY);
                }
                hideCreateMenu();
                return;
            }

            // Handle left click
            if (e.button === 0) {
                if (activeDraggable) {
                    const dragDuration = Date.now() - dragStartTime;
                    activeDraggable.classList.remove('being-dragged');
                    
                    // Only toggle info on click (no significant drag)
                    if (dragDuration < DRAG_THRESHOLD) {
                        toggleObjectInfo(activeDraggable);
                    }
                    
                    activeDraggable = null;
                    menuInteractionId = null;
                }
            }
        });

        // Handle rate adjustment with axis-based distance
        function startRateAdjustment(obj, startX, startY) {
            rateAdjustmentStart = { 
                x: startX, 
                y: startY, 
                initialRate: parseFloat(obj.dataset.pulseRate),
                axis: null
            };
            
            function onMouseMove(e) {
                if (!rateAdjustmentStart) return;
                
                const dx = e.pageX - rateAdjustmentStart.x;
                const dy = e.pageY - rateAdjustmentStart.y;
                
                // Determine axis if not set
                if (!rateAdjustmentStart.axis) {
                    if (Math.abs(dx) > Math.abs(dy)) {
                        rateAdjustmentStart.axis = 'x';
                    } else {
                        rateAdjustmentStart.axis = 'y';
                    }
                }
                
                // Calculate rate based on axis distance
                const distance = Math.abs(rateAdjustmentStart.axis === 'x' ? dx : dy);
                const newRate = Math.max(0.1, Math.min(5, distance / 100));
                
                obj.dataset.pulseRate = `${newRate.toFixed(1)}s`;
                obj.style.setProperty('--pulse-rate', `${newRate}s`);
                updatePulseAnimations(obj);
            }

            function onMouseUp() {
                rateAdjustmentStart = null;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        // Add wheel event for pulse rate adjustment
        document.addEventListener('wheel', (e) => {
            if (isTouchDevice) return; // Skip if touch device
            
            const target = findDraggableTarget(e);
            if (target && target.dataset.state === 'active') {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.1 : -0.1;
                updatePulseRate(target, delta);
            }
        });

        // Add double-click handler for desktop
        document.addEventListener('dblclick', (e) => {
            if (isTouchDevice) return;
            
            const target = findDraggableTarget(e);
            if (target) {
                togglePulseShape(target);
                e.preventDefault(); // Prevent text selection
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            // Ensure objects stay within bounds
            document.querySelectorAll('.draggable').forEach(obj => {
                const x = parseFloat(obj.style.left);
                const y = parseFloat(obj.style.top);
                
                obj.style.left = `${Math.min(Math.max(x, 0), window.innerWidth)}px`;
                obj.style.top = `${Math.min(Math.max(y, 0), window.innerHeight)}px`;
            });
        });

        // Create initial objects
        createObject('🔵');
        createObject('🔴');
        createObject('🟡');
    </script>
</body>
</html>
